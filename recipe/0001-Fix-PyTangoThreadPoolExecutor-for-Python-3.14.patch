From ae0f59fd80e0496d5bd45ba4b1508c0196d2bb03 Mon Sep 17 00:00:00 2001
From: Benjamin Bertrand <beenje@gmail.com>
Date: Tue, 9 Sep 2025 17:12:56 +0200
Subject: [PATCH 1/2] Add link to Python 3.14 code

---
 tango/utils.py | 7 +++----
 1 file changed, 3 insertions(+), 4 deletions(-)

diff --git a/tango/utils.py b/tango/utils.py
index ee1d6be6..8afe855b 100644
--- a/tango/utils.py
+++ b/tango/utils.py
@@ -2709,11 +2709,10 @@ else:
 #
 # The `_adjust_thread_count` method below is a slightly modified version of the code from
 # https://github.com/python/cpython/blob/3.12/Lib/concurrent/futures/thread.py
+# and
+# https://github.com/python/cpython/blob/3.14/Lib/concurrent/futures/thread.py
 
-# Copyright (c) 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010,
-# 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020, 2021, 2022,
-# 2023 Python Software Foundation;
-# All Rights Reserved
+# Copyright (c) Python Software Foundation; All Rights Reserved
 
 from concurrent.futures import ThreadPoolExecutor
 from concurrent.futures.thread import _worker, _threads_queues
-- 
2.39.5 (Apple Git-154)


From 7ca2399ecc241df396c67f074b93d796c94defde Mon Sep 17 00:00:00 2001
From: Benjamin Bertrand <benjamin.bertrand@maxiv.lu.se>
Date: Tue, 9 Sep 2025 10:01:53 +0200
Subject: [PATCH 2/2] Fix PyTangoThreadPoolExecutor for Python >=3.14

Internal implementation of ThreadPoolExecutor changed in 3.14
---
 tango/utils.py | 40 ++++++++++++++++++++++++++++++----------
 1 file changed, 30 insertions(+), 10 deletions(-)

diff --git a/tango/utils.py b/tango/utils.py
index 8afe855b..f3587b68 100644
--- a/tango/utils.py
+++ b/tango/utils.py
@@ -2736,26 +2736,46 @@ class PyTangoThreadPoolExecutor(ThreadPoolExecutor):
         num_threads = len(self._threads)
         if num_threads < self._max_workers:
             thread_name = "%s_%d" % (self._thread_name_prefix or self, num_threads)
-            t = threading.Thread(
-                name=thread_name,
-                target=_thread_pool_executor_worker,
-                args=(
-                    weakref.ref(self, weakref_cb),
-                    self._work_queue,
-                    self._initializer,
-                    self._initargs,
-                ),
-            )
+            if hasattr(self, "_initializer"):
+                # Python < 3.14
+                t = threading.Thread(
+                    name=thread_name,
+                    target=_thread_pool_executor_worker,
+                    args=(
+                        weakref.ref(self, weakref_cb),
+                        self._work_queue,
+                        self._initializer,
+                        self._initargs,
+                    ),
+                )
+            else:
+                # Python >= 3.14
+                t = threading.Thread(
+                    name=thread_name,
+                    target=_thread_pool_executor_ctx_worker,
+                    args=(
+                        weakref.ref(self, weakref_cb),
+                        self._create_worker_context(),
+                        self._work_queue,
+                    ),
+                )
             t.start()
             self._threads.add(t)
             _threads_queues[t] = self._work_queue
 
 
+# Override _worker for Python < 3.14
 def _thread_pool_executor_worker(executor_reference, work_queue, initializer, initargs):
     with EnsureOmniThread():
         _worker(executor_reference, work_queue, initializer, initargs)
 
 
+# Override _worker for Python >= 3.14
+def _thread_pool_executor_ctx_worker(executor_reference, ctx, work_queue):
+    with EnsureOmniThread():
+        _worker(executor_reference, ctx, work_queue)
+
+
 def _get_command_inout_param(self, cmd_name, cmd_param=None):
     if cmd_param is None:
         return DeviceData()
-- 
2.39.5 (Apple Git-154)

